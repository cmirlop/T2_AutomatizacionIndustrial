\subsection{Grafcet Máquina 7 embalaje}
Esta máquina (\hyperref[graf:maq7]{Máquina 7, embalaje}) es similar a la máquina 5 de la línea de soportes (\hyperref[sec:map5_sop]{Sección de la Máquina 5 de Soportes}). Se cuenta el número de piezas embaladas para, al alcanzar el cupo, levantar el clamper y mover la caja a otra zona.
 
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{./Figuras/maq7_EMB.png}
	\medskip
	\label{fig:maq7_emb}
	\caption{Máquina 7 de la línea de embalaje}
\end{figure}

\begin{figure}[H]
	\centering
	\scalebox{0.75}{\input{./grafcets/10_Seta.tex}}
	\medskip
	\caption{Grafcet de la Máquina 7 embalaje}
	\label{graf:maq7}
\end{figure}

Este grafcet está descompuesto en las siguientes ecuaciones algebráicas:\\

\setlength{\sepsGrups}{2ex}

% Temporizadores (formato tipo ejemplo)
$T_{1}=PT_{1}/X_{102}$\\
$T_{2}=PT_{2}/X_{103}$\\
$T_{3}=PT_{3}/X_{106}$\\[\sepsGrups]

% PRODUCCIÓN

% Transiciones (sin FORCE_CURRENT)
$S_{100} = \mathtt{FirstScan} + X_{107}$\\
$S_{101} = X_{100}\cdot \mathtt{Act\_Proceso}$\\
$S_{102} = X_{101}\cdot \mathtt{S5}$\\
$S_{103} = X_{102}\cdot \mathtt{T1.Q}$\\
$S_{104} = X_{103}\cdot \mathtt{T2.Q} + X_{105}\cdot (\mathtt{Counter.CV}<\mathtt{PiezasPalet})$\\
$S_{105} = X_{104}\cdot \mathtt{Pieza\_Empaquetada}$\\
$S_{106} = X_{105}\cdot (\mathtt{Counter.CV}=\mathtt{PiezasPalet})$\\
$S_{107} = X_{106}\cdot \mathtt{T3.Q}$\\[\sepsGrups]

% Etapas (sin FORCE_INIT)
$X_{100} = S_{100} + X_{100}\cdot \Not{S_{101}}$\\
$X_{101} = S_{101} + X_{101}\cdot \Not{S_{102}}$\\
$X_{102} = S_{102} + X_{102}\cdot \Not{S_{103}}$\\
$X_{103} = S_{103} + X_{103}\cdot \Not{S_{104}}$\\
$X_{104} = S_{104} + X_{104}\cdot \Not{S_{105}}$\\
$X_{105} = S_{105} + X_{105}\cdot \Not{(S_{106}+S_{104})}$\\
$X_{106} = S_{106} + X_{106}\cdot \Not{S_{107}}$\\
$X_{107} = S_{107} + X_{107}\cdot \Not{S_{100}}$\\[\sepsGrups]

% Contadores (tipo ejemplo, usando C como valor del contador)
IF X100 THEN\\
\hspace*{2em}C = 0\\
END IF\\
IF S105 THEN\\
\hspace*{2em}C = C + 1\\
END IF\\[\sepsGrups]

% Marcas / salidas
$\mathtt{Maq\_Libre}      = X_{100}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{QC7}            = (X_{101}+X_{102}+X_{106}+\mathtt{Mantenimiento\_Cinta}+\mathtt{vaciado\_cinta})\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{QCLAMP}         = (X_{103}+\mathtt{Mantenimiento\_Clamper})\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{QCLAMP\_SUB}    = (X_{106}+\mathtt{Mantenimiento\_SubirClamp}+\mathtt{vaciado\_subclamp})\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{HayPieza}       = X_{104}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{Pieza\_Entregada}= X_{107}$\\



\subsection{Grafcet de Mantenimiento}
El \hyperref[graf:mantenimiento]{Grafcet de Mantenimiento}
 asegura que la máquina funciona correctamente antes de procesar
 lotes. Se ejecuta al arrancar la máquina y después de la ejecución
  del \hyperref[graf:principal_vaciado]{Grafcet Principal de Vaciado},
   garantizando que la puesta en marcha tras soltar la seta sea
    correcta.

	Dispone tamibién de un botón en la pantalla de configuración del HMI
	(\ref{fig:HMI_config}) para que un 
	usuario con permisos pueda activarlo
	en cualquier momento.

\begin{figure}[H]
	\centering
	\scalebox{0.75}{\input{./grafcets/11_SETA_Cinta_fin.tex}}
	\medskip
	\caption{Grafcet de Mantenimiento}
	\label{graf:mantenimiento}
\end{figure}

Este grafcet está descompuesto en las siguientes ecuaciones algebráicas:\\


\setlength{\sepsGrups}{2ex}

% PRODUCCIÓN

% Transiciones (sin FORCE_CURRENT)
$S_{110} = \mathtt{FirstScan} + X_{117}$\\
$S_{111} = X_{110}\cdot (\mathtt{Act\_Mantenimiento}+\mathtt{Act\_Mantenimiento\_Emergencia}+\mathtt{Act\_Mantenimiento\_HMI})$\\
$S_{112} = X_{111}\cdot \Not{\mathtt{Sensores}}$\\
$S_{113} = X_{112}\cdot \mathtt{T1.Q}$\\
$S_{114} = X_{113}\cdot \mathtt{T2.Q}$\\
$S_{115} = X_{114}\cdot \mathtt{T3.Q}$\\
$S_{116} = X_{115}\cdot \mathtt{T4.Q}$\\
$S_{117} = X_{116}\cdot \mathtt{T5.Q}$\\[\sepsGrups]

% Etapas (sin FORCE_INIT)
$X_{110} = S_{110} + X_{110}\cdot \Not{S_{111}}$\\
$X_{111} = S_{111} + X_{111}\cdot \Not{S_{112}}$\\
$X_{112} = S_{112} + X_{112}\cdot \Not{S_{113}}$\\
$X_{113} = S_{113} + X_{113}\cdot \Not{S_{114}}$\\
$X_{114} = S_{114} + X_{114}\cdot \Not{S_{115}}$\\
$X_{115} = S_{115} + X_{115}\cdot \Not{S_{116}}$\\
$X_{116} = S_{116} + X_{116}\cdot \Not{S_{117}}$\\
$X_{117} = S_{117} + X_{117}\cdot \Not{S_{110}}$\\[\sepsGrups]

% Marcas / salidas
$\mathtt{Activar\_Cintas}    = X_{112}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{Activar\_Transfers} = X_{113}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{BAJAR\_ROBOTS}      = X_{114}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{SUBIR\_CLAMPERS}    = X_{114}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{GRIPPERS}          = X_{115}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{CLAMPER}           = X_{115}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{MOVER\_HOR}         = X_{116}\cdot \Not{\mathtt{STOP\_ACT}}$\\
$\mathtt{Fin\_Mantenimiento} = X_{117}\cdot \Not{\mathtt{STOP\_ACT}}$\\




\subsection{Grafcet Principal de Vaciado}
El \hyperref[graf:principal_vaciado]{Grafcet Principal de Vaciado}
 se activa tras desenclavar la seta de emergencia, 
 ya que no se aceptan las piezas que
  estuvieran en la máquina durante la emergencia.
   Las máquinas también se pueden vaciar 
   si un usuario con permisos pulsa el botón
    de vaciado del HMI (\ref{fig:HMI_config}).

\begin{figure}[H]
	\centering
	\scalebox{0.75}{\input{./grafcets/12_Alarma_Cinta_fin.tex}}
	\medskip
	\caption{Grafcet Principal de Vaciado}
	\label{graf:principal_vaciado}
\end{figure}

Este grafcet está descompuesto en las siguientes ecuaciones algebráicas:\\

\setlength{\sepsGrups}{2ex}

% PRODUCCIÓN

% Transiciones (sin FORCE_CURRENT)
$s_{120} = \mathtt{FirstScan} + x_{122}$\\
$s_{121} = x_{120}\cdot (\mathtt{Act\_Vaciado}+\mathtt{Act\_Vaciado\_HMI})$\\
$s_{122} = x_{121}\cdot \mathtt{vac\_finalizados}$\\[\sepsGrups]

% Etapas (sin FORCE_INIT)
$x_{120} = s_{120} + x_{120}\cdot \Not{s_{121}}$\\
$x_{121} = s_{121} + x_{121}\cdot \Not{s_{122}}$\\
$x_{122} = s_{122} + x_{122}\cdot \Not{s_{120}}$\\[\sepsGrups]

% Marcas / salidas
$\mathtt{act\_vaciados\_maquinas} = x_{121}$\\
$\mathtt{Fin\_vaciado}            = x_{122}$\\

\subsection{Grafcet vaciado tipo 1}
 \subsubsection{Grafcet Vaciado 1}
 
 El \hyperref[graf:vaciado_1]{Grafcet de Vaciado 1} se 
 activa por medio del \hyperref[graf:principal_vaciado]{Grafcet Principal de Vaciado}, 
 y este vacía las siguientes máquinas:
\begin{itemize}
	\item Máquina 1:
	\begin{itemize}
		\item \hyperref[fig:maq1]{Vacunas, Soportes y Embalajes}
	\end{itemize}
	\item Máquina 2:
	\begin{itemize}
		\item \hyperref[fig:maq2]{Vacunas, Soportes y Embalajes}
	\end{itemize}
	\item Máquina 3:
	\begin{itemize}
		\item \hyperref[fig:maq3]{Vacunas, Soportes y Embalajes}
	\end{itemize}
	\item Máquina 4:
	\begin{itemize}
		\item \hyperref[fig:maq4]{Vacunas, Soportes y Embalajes}
	\end{itemize}
\end{itemize}

\begin{figure}[H]
	\centering
	\scalebox{0.75}{\input{./grafcets/grafcet_02.tex}}
	\medskip
	\caption{Grafcet de vaciado tipo 1}
	\label{graf:vaciado_1}
\end{figure}

Este grafcet está descompuesto en las siguientes ecuaciones algebráicas:\\

\setlength{\sepsGrups}{2ex}

% PRODUCCIÓN

% Transiciones (sin FORCE_CURRENT_E)
$S_{125} = \mathtt{FirstScan} + x_{126b}\cdot \Not{\mathtt{S3\_1}} + x_{127}\cdot \mathtt{Fin\_vaciado}$\\
$S_{126} = X_{125}\cdot \mathtt{Act\_Vaciado\_Maquina} + x_{126b}\cdot \Not{\mathtt{S3}}$\\
$S_{126a} = X_{126}\cdot \mathtt{F\_S2.Q}$\\
$S_{126b} = \mathtt{S3}\cdot (X_{126}+x_{126a})$\\
$S_{127} = X_{126}\cdot \mathtt{T1.Q}$\\[\sepsGrups]

% Etapas (sin FORCE_INIT_E)
$X_{125} = S_{125} + X_{125}\cdot \Not{S_{126}}$\\
$X_{126} = S_{126} + X_{126}\cdot \Not{(S_{126a}+S_{127}+S_{126b})}$\\
$x_{126a} = S_{126a} + x_{126a}\cdot \Not{S_{126b}}$\\
$x_{126b} = S_{126b} + x_{126b}\cdot \Not{S_{125}}$\\
$x_{127} = S_{127} + x_{127}\cdot \Not{S_{125}}$\\[\sepsGrups]

% Marcas / salidas
$\mathtt{QCINTA1} = X_{126}$\\
$\mathtt{QCINTA2} = X_{126} + x_{126a}$\\
$\mathtt{FIN\_Vaciado\_MAq} = x_{127}$\\
$\mathtt{QTrans} = x_{126b}$\\



\subsection{Grafcet vaciado tipo 2}
 \subsubsection{Grafcet Vaciado 2}
 El \hyperref[graf:vaciado_2]{Grafcet de Vaciado 2} se activa por medio del
  \hyperref[graf:principal_vaciado]{Grafcet Principal de Vaciado}, y este vacía
 las siguientes máquinas:
\begin{itemize}
	\item Máquina 5 de Soportes:
	\begin{itemize}
		\item \hyperref[fig:maq5]{Soporte}
	\end{itemize}
	\item Máquina 5 de vacunas y 6 de soportes:
	\begin{itemize}
		\item \hyperref[fig:maq5_vac_6_sop]{Vacunas y Soportes}
	\end{itemize}
	\item Máquina 6 y 7 de embalaje:
	\begin{itemize}
		\item \hyperref[graf:maq6_emb]{Embalajes}
		\item \hyperref[graf:maq7]{Embalajes}
	\end{itemize}
\end{itemize}

\begin{figure}[H]
	\centering
	\scalebox{0.75}{\input{./grafcets/grafcet_03.tex}}
	\medskip
	\caption{Grafcet de vaciado tipo 2}
	\label{graf:vaciado_2}
\end{figure}

Este grafcet está descompuesto en las siguientes ecuaciones algebráicas:\\

\setlength{\sepsGrups}{2ex}

% PRODUCCIÓN

% Transiciones (sin FORCE_CURRENT)
$S_{130} = \mathtt{FirstScan} + x_{132}\cdot \mathtt{Fin\_vaciado}$\\
$S_{131} = x_{130}\cdot \mathtt{Act\_Vaciado\_maquina}$\\
$s_{132} = x_{131}\cdot \mathtt{T1.Q}$\\[\sepsGrups]

% Etapas (sin FORCE_INIT)
$x_{130} = S_{130} + x_{130}\cdot \Not{S_{131}}$\\
$x_{131} = S_{131} + x_{131}\cdot \Not{s_{132}}$\\
$x_{132} = s_{132} + x_{132}\cdot \Not{S_{130}}$\\[\sepsGrups]

% Marcas / salidas
$\mathtt{Vaciados\_maq\_1} = x_{131}$\\
$\mathtt{Vaciados\_maq\_2} = x_{131}$\\
$\mathtt{Vaciados\_maq\_3} = x_{131}$\\
$\mathtt{Vaciados\_maq\_4} = x_{131}$\\
$\mathtt{Vaciados\_maq\_5} = x_{131}$\\
$\mathtt{Vaciados\_maq\_6} = x_{131}$\\
$\mathtt{Vaciados\_maq\_7} = x_{131}$\\
$\mathtt{Vaciados\_maq\_8} = x_{131}$\\




\subsection{Gestión de las alarmas}
El \hyperref[graf:emerg2]{Grafcet de alarmas en guía GEMMA} gestiona las alarmas de cada máquina,
asegurándose de que la máquina se detenga cuando haya una alarma activa y 
permitiendo resetear la alarma cuando se haya solucionado el problema, o reanudarlo 
desde donde se havia parado si el problema era leve.

Este grafcet se encuentra implementado en todas las máquinas de la línea de producción, 
siguiendo la guía GEMMA para la estructura del código.
\begin{figure}[H]
	\centering
	\scalebox{0.75}{\input{./grafcets/gestion_alarma.tex}}
	\medskip
	\caption{Grafcet de alarmas en guía GEMMA}
	\label{graf:emerg2}
\end{figure}

Este grafcet está descompuesto en las siguientes ecuaciones algebráicas:\\

\setlength{\sepsGrups}{2ex}

% ALARMAS

% Transiciones (sin FORCE_CURRENT_E)
$S_{10a} = X_{13a} + \mathtt{FirstScan}$\\
$S_{11a} = X_{10a}\cdot \mathtt{Alarma}$\\
$S_{12a} = X_{11a}\cdot \mathtt{Reset}$\\
$S_{13a} = X_{12a} + X_{11a}\cdot \mathtt{Resume}$\\[\sepsGrups]

% Etapas (sin FORCE_INIT_E)
$X_{10a} = S_{10a} + X_{10a}\cdot \Not{S_{11a}}$\\
$X_{11a} = S_{11a} + X_{11a}\cdot \Not{(S_{12a}+S_{13a})}$\\
$X_{12a} = S_{12a} + X_{12a}\cdot \Not{S_{13a}}$\\
$X_{13a} = S_{13a} + X_{13a}\cdot \Not{S_{10a}}$\\[\sepsGrups]

% Marcas / salidas
$\mathtt{STOP\_ACT} = X_{11a}$\\
$\mathtt{FORCE\_INIT} = X_{12a}$\\
$\mathtt{FORCE\_CURRENT} = X_{11a}$\\
$\mathtt{RESET\_ALARMA} = X_{13a}$\\




\subsection{Gestión de la seta de emergencia}

El \hyperref[graf:emerg_gem]{Grafcet de la seta de emergencia } ,gestiona la señal que produce la
seta de emergencia, y todos los pasos que debe de seguir la máquina cuando se desenclava la seta 
para poder rearmar la máquina y seguir con el proceso de producción.

Lo primero que hacemos es activar la variable ''EMERGENCIA'' comunicando a todos 
las partes del programa que la seta se ha enclavado, y por lo tanto la máquina
 debe de detenerse. Lo siguiente es desenclavar la seta, y una vez desenclavada,
 pular ''reset'' para activar el vaciado de la máquina, ya que no se aceptan las piezas
  que estuvieran en la máquina durante la emergencia. Una vez finalizado el vaciado,
   se activa el mantenimiento para comprobar que todo funciona correctamente, dejando 
   la máquina lista para volver a pulsar marcha o entrar a modo manual.


\begin{figure}[H]
	\centering
	\scalebox{0.75}{\input{./grafcets/11_SETA_gen.tex}}
	\medskip
	\caption{Grafcet de la gestión de la seta}
	\label{graf:emerg_gem}
\end{figure}




El \hyperref[graf:emerg_seta]{Grafcet de la seta de emergencia en guía GEMMA}, se encuentra implementado en todas las máquinas de la línea de producción, 
siguiendo la guia GEMMA para la estructura del código. Aunque como hemos hablado con anterioridad,
las señales que le llegan a cada bloque de la máquina son que se ha enclavado la seta, y cuando
ya se han pasado todas la verificaciones para reanudar el proceso.

\begin{figure}[H]
	\centering
	\scalebox{0.75}{\input{./grafcets/11_SETA.tex}}
	\medskip
	\caption{Grafcet de la seta de emergencia en guía GEMMA}
	\label{graf:emerg_seta}
\end{figure}


Este grafcet está descompuesto en las siguientes ecuaciones algebráicas:\\


\setlength{\sepsGrups}{2ex}

% EMERGENCIA (manteniendo FORCE_INIT_E y FORCE_CURRENT_E)

% Transiciones
$S_{10e} = X_{12e}\cdot \mathtt{CI} + \mathtt{FirstScan}$\\
$S_{11e} = X_{10e}\cdot \mathtt{Emergencia}$\\
$S_{12e} = X_{11e}$\\[\sepsGrups]

% Etapas
$X_{10e} = S_{10e} + X_{10e}\cdot \Not{S_{11e}}$\\
$X_{11e} = S_{11e} + X_{11e}\cdot \Not{S_{12e}}$\\
$X_{12e} = S_{12e} + X_{12e}\cdot \Not{S_{10e}}$\\[\sepsGrups]

% Marcas / salidas (NO se eliminan)
$\mathtt{FORCE\_INIT\_E} = X_{11e}$\\
$\mathtt{FORCE\_CURRENT\_E} = X_{12e}$\\
